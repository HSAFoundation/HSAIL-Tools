#!/bin/bash

set -e
export BUILD_HSAILASM=1
export BUILD_LIBBRIGDWARF=1
export LLVM_PATH=/srv/hsa/drivers/opencl/compiler/llvm
export LLVM_SUPPORT_LIB_DIR=$LLVM_PATH/lib/Support
export ELFTOOLCHAIN_PATH=/srv/hsa/drivers/hsa/contrib/elftoolchain
export LIBELF_PATH=$ELFTOOLCHAIN_PATH/libelf
export LIBDWARF_PATH=/srv/hsa/drivers/sc/HSAIL/hsail-tools/libdwarf
export RE2C_EXECUTABLE=/srv/dk/lnx/re2c/re2c

cd ..

mkdir -p build/lnx32
cd build/lnx32
export BUILD_SUBDIR=build/lnx/B_dbg
export EXTRA_CFLAGS=-m32
cmake -DCMAKE_BUILD_TYPE=Debug -G "Unix Makefiles" -DBUILD_HSAILASM=$BUILD_HSAILASM -DBUILD_LIBBRIGDWARF=$BUILD_LIBBRIGDWARF -DLLVM_PATH=$LLVM_PATH -DLLVM_SUPPORT_LIB=$LLVM_SUPPORT_LIB_DIR/$BUILD_SUBDIR/LLVMSupport.a -DLIBELF_INCLUDE_DIRS="$LIBELF_PATH;$LIBELF_PATH/../common" -DLIBDWARF_INCLUDE_DIRS=$LIBDWARF_PATH/src -DLIBELF_LIBRARIES=$LIBELF_PATH/$BUILD_SUBDIR/libelf.a -DLIBDWARF_LIBRARIES=$LIBDWARF_PATH/$BUILD_SUBDIR/libdwarf.a -DEXTRA_CFLAGS=$EXTRA_CFLAGS -DRE2C_EXECUTABLE=$RE2C_EXECUTABLE "$@" ../..
cd ../..

mkdir -p build/lnx64
cd build/lnx64
export BUILD_SUBDIR=build/lnx64a/B_dbg
export EXTRA_CFLAGS=-m64
cmake -DCMAKE_BUILD_TYPE=Debug -G "Unix Makefiles" -DBUILD_HSAILASM=$BUILD_HSAILASM -DBUILD_LIBBRIGDWARF=$BUILD_LIBBRIGDWARF -DLLVM_PATH=$LLVM_PATH -DLLVM_SUPPORT_LIB=$LLVM_SUPPORT_LIB_DIR/$BUILD_SUBDIR/LLVMSupport.a -DLIBELF_INCLUDE_DIRS="$LIBELF_PATH;$LIBELF_PATH/../common;$LIBDWARF_PATH/src" -DLIBDWARF_INCLUDE_DIRS=$LIBDWARF_PATH/src -DLIBELF_LIBRARIES=$LIBELF_PATH/$BUILD_SUBDIR/libelf.a -DLIBDWARF_LIBRARIES=$LIBDWARF_PATH/$BUILD_SUBDIR/libdwarf.a -DEXTRA_CFLAGS=$EXTRA_CFLAGS -DRE2C_EXECUTABLE=$RE2C_EXECUTABLE "$@" ../..
cd ../..
